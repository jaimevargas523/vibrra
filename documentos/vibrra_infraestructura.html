<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIBRRA ‚Äî Infraestructura Tecnol√≥gica</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap');

:root {
  --gold:    #FFE566;
  --gold-m:  #D4A017;
  --gold-dk: #A97010;
  --black:   #080808;
  --dark:    #101010;
  --card:    #161616;
  --border:  #222;
  --text:    #E8E8E8;
  --muted:   #666;

  --client:   #FFE566;
  --ext:      #FF6B6B;
  --firebase: #FF8C42;
  --rtdb:     #00D9A3;
  --fn:       #A78BFA;
  --external: #60C0F0;
  --storage:  #F472B6;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  background: var(--black);
  color: var(--text);
  font-family: 'Outfit', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ GRID DE FONDO ‚îÄ‚îÄ */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    linear-gradient(rgba(255,229,102,.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,229,102,.03) 1px, transparent 1px);
  background-size: 40px 40px;
  pointer-events: none;
  z-index: 0;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
  position: relative;
  z-index: 10;
  padding: 32px 48px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: flex-end;
  justify-content: space-between;
}

.logo {
  font-family: 'Playfair Display', serif;
  font-size: 32px;
  font-weight: 900;
  color: var(--gold);
  letter-spacing: -1px;
}
.logo-sub {
  font-size: 12px;
  letter-spacing: 4px;
  text-transform: uppercase;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
  margin-top: 4px;
}

.legend {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  justify-content: flex-end;
}
.leg { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
.leg-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

/* ‚îÄ‚îÄ CANVAS AREA ‚îÄ‚îÄ */
.canvas {
  position: relative;
  z-index: 1;
  padding: 40px 48px 60px;
}

/* ‚îÄ‚îÄ SVG CONNECTORS ‚îÄ‚îÄ */
.svg-lines {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 2;
}

/* ‚îÄ‚îÄ LAYERS ‚îÄ‚îÄ */
.layer {
  margin-bottom: 0;
}

.layer-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 3px;
  color: var(--muted);
  margin-bottom: 16px;
  padding-left: 4px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.layer-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}

.nodes-row {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  align-items: flex-start;
  margin-bottom: 32px;
}

/* ‚îÄ‚îÄ NODE CARDS ‚îÄ‚îÄ */
.node {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px 18px;
  cursor: pointer;
  transition: all .25s cubic-bezier(.4,0,.2,1);
  position: relative;
  z-index: 5;
  min-width: 160px;
}

.node:hover {
  transform: translateY(-3px);
  border-color: #333;
  box-shadow: 0 8px 32px rgba(0,0,0,.6);
}

.node.active {
  transform: translateY(-3px);
}

.node-icon {
  font-size: 28px;
  margin-bottom: 10px;
  display: block;
  line-height: 1;
}

.node-name {
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 3px;
}

.node-desc {
  font-size: 11px;
  color: var(--muted);
  line-height: 1.4;
}

.node-badge {
  position: absolute;
  top: 10px;
  right: 10px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 9px;
  padding: 2px 6px;
  border-radius: 10px;
  font-weight: 600;
}

/* colores por tipo */
.node.client    { border-top: 3px solid var(--client); }
.node.ext       { border-top: 3px solid var(--ext); }
.node.firebase  { border-top: 3px solid var(--firebase); }
.node.rtdb      { border-top: 3px solid var(--rtdb); }
.node.fn        { border-top: 3px solid var(--fn); }
.node.external  { border-top: 3px solid var(--external); }
.node.storage   { border-top: 3px solid var(--storage); }

.node.client   .node-name { color: var(--client); }
.node.ext      .node-name { color: var(--ext); }
.node.firebase .node-name { color: var(--firebase); }
.node.rtdb     .node-name { color: var(--rtdb); }
.node.fn       .node-name { color: var(--fn); }
.node.external .node-name { color: var(--external); }
.node.storage  .node-name { color: var(--storage); }

.node.client   .node-badge { background: rgba(255,229,102,.12); color: var(--client); }
.node.ext      .node-badge { background: rgba(255,107,107,.12); color: var(--ext); }
.node.firebase .node-badge { background: rgba(255,140,66,.12);  color: var(--firebase); }
.node.rtdb     .node-badge { background: rgba(0,217,163,.12);   color: var(--rtdb); }
.node.fn       .node-badge { background: rgba(167,139,250,.12); color: var(--fn); }
.node.external .node-badge { background: rgba(96,192,240,.12);  color: var(--external); }
.node.storage  .node-badge { background: rgba(244,114,182,.12); color: var(--storage); }

/* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
.detail-panel {
  position: fixed;
  top: 0; right: -440px;
  width: 420px;
  height: 100vh;
  background: #0E0E0E;
  border-left: 1px solid var(--border);
  z-index: 100;
  transition: right .35s cubic-bezier(.4,0,.2,1);
  overflow-y: auto;
  padding: 32px 28px;
}

.detail-panel.open { right: 0; }

.detail-close {
  position: absolute;
  top: 20px; right: 20px;
  background: none;
  border: 1px solid var(--border);
  color: var(--muted);
  width: 32px; height: 32px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex; align-items: center; justify-content: center;
  transition: all .2s;
}
.detail-close:hover { border-color: var(--gold); color: var(--gold); }

.detail-icon { font-size: 40px; margin-bottom: 16px; }
.detail-name {
  font-family: 'JetBrains Mono', monospace;
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 4px;
}
.detail-type {
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 20px;
}
.detail-desc {
  font-size: 13px;
  line-height: 1.7;
  color: #CCC;
  margin-bottom: 24px;
}

.detail-section {
  margin-bottom: 20px;
}
.detail-section-title {
  font-size: 10px;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--muted);
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 10px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border);
}

.detail-item {
  display: flex;
  gap: 10px;
  padding: 6px 0;
  font-size: 12px;
  border-bottom: 1px solid rgba(255,255,255,.03);
  align-items: flex-start;
}
.detail-item-key {
  font-family: 'JetBrains Mono', monospace;
  color: #B0C4FF;
  min-width: 130px;
  flex-shrink: 0;
  font-size: 11px;
}
.detail-item-val {
  color: var(--muted);
  font-size: 11px;
  line-height: 1.4;
}

.detail-flow {
  background: rgba(255,255,255,.03);
  border-radius: 8px;
  padding: 14px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  line-height: 2;
  color: #AAA;
  border: 1px solid var(--border);
}
.detail-flow .step { color: var(--gold); margin-right: 6px; }
.detail-flow .arrow { color: var(--muted); }

.connects-to {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 8px;
}
.connect-chip {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
  padding: 3px 8px;
  border-radius: 4px;
  border: 1px solid var(--border);
  color: var(--muted);
}

/* ‚îÄ‚îÄ FLOW ANIMATION LINES ‚îÄ‚îÄ */
@keyframes flowRight {
  0%   { stroke-dashoffset: 100; opacity: 0; }
  10%  { opacity: 1; }
  90%  { opacity: 1; }
  100% { stroke-dashoffset: 0; opacity: 0; }
}

.flow-line {
  fill: none;
  stroke-width: 1.5;
  stroke-dasharray: 6 4;
  stroke-dashoffset: 100;
  animation: flowRight 3s linear infinite;
}

/* ‚îÄ‚îÄ OVERLAY ‚îÄ‚îÄ */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  z-index: 99;
  opacity: 0;
  pointer-events: none;
  transition: opacity .3s;
}
.overlay.active { opacity: 1; pointer-events: all; }

/* ‚îÄ‚îÄ SCENARIO TABS ‚îÄ‚îÄ */
.scenario-bar {
  position: relative;
  z-index: 10;
  padding: 0 48px;
  background: var(--dark);
  border-bottom: 1px solid var(--border);
  display: flex;
  gap: 0;
  overflow-x: auto;
}
.scenario-tab {
  padding: 12px 20px;
  font-size: 12px;
  font-weight: 500;
  color: var(--muted);
  cursor: pointer;
  border-bottom: 2px solid transparent;
  white-space: nowrap;
  transition: all .2s;
  font-family: 'JetBrains Mono', monospace;
}
.scenario-tab:hover { color: var(--text); }
.scenario-tab.active { color: var(--gold); border-bottom-color: var(--gold); }

.scenario-section { display: none; }
.scenario-section.active { display: block; }

/* ‚îÄ‚îÄ FLOW DESCRIPTION BANNER ‚îÄ‚îÄ */
.flow-banner {
  background: rgba(255,229,102,.04);
  border: 1px solid rgba(255,229,102,.12);
  border-radius: 10px;
  padding: 14px 18px;
  margin-bottom: 28px;
  font-size: 12px;
  color: #CCC;
  line-height: 1.6;
  font-family: 'JetBrains Mono', monospace;
}
.flow-banner strong { color: var(--gold); }

/* ‚îÄ‚îÄ PULSE DOT ‚îÄ‚îÄ */
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: .4; transform: scale(1.5); }
}
.pulse {
  display: inline-block;
  width: 6px; height: 6px;
  border-radius: 50%;
  background: var(--rtdb);
  animation: pulse 2s ease-in-out infinite;
  margin-right: 6px;
  vertical-align: middle;
}

</style>
</head>
<body>

<header>
  <div>
    <div class="logo">VIBRRA</div>
    <div class="logo-sub">Infraestructura Tecnol√≥gica ‚Äî v3.0</div>
  </div>
  <div class="legend">
    <div class="leg"><div class="leg-dot" style="background:var(--client)"></div>Clientes / App</div>
    <div class="leg"><div class="leg-dot" style="background:var(--ext)"></div>Extensi√≥n Chrome</div>
    <div class="leg"><div class="leg-dot" style="background:var(--firebase)"></div>Firestore</div>
    <div class="leg"><div class="leg-dot" style="background:var(--rtdb)"></div>Realtime DB</div>
    <div class="leg"><div class="leg-dot" style="background:var(--fn)"></div>Functions</div>
    <div class="leg"><div class="leg-dot" style="background:var(--external)"></div>Externos</div>
  </div>
</header>

<div class="scenario-bar">
  <div class="scenario-tab active" onclick="showScenario('arq')">üèó Arquitectura general</div>
  <div class="scenario-tab" onclick="showScenario('puja')">üéµ Flujo de puja</div>
  <div class="scenario-tab" onclick="showScenario('sesion')">üîê Inicio de sesi√≥n</div>
  <div class="scenario-tab" onclick="showScenario('recarga')">üí≥ Recarga Wompi</div>
  <div class="scenario-tab" onclick="showScenario('cierre')">üîí Cierre de sesi√≥n</div>
</div>

<div class="canvas">

  <!-- ‚ïê‚ïê ARQUITECTURA GENERAL ‚ïê‚ïê -->
  <div id="sec-arq" class="scenario-section active">

    <!-- CAPA 1: CLIENTES -->
    <div class="layer">
      <div class="layer-label">Capa 1 ‚Äî Interfaces de usuario</div>
      <div class="nodes-row">
        <div class="node client" id="n-app" onclick="showDetail('app')">
          <span class="node-badge">Flutter</span>
          <span class="node-icon">üì±</span>
          <div class="node-name">App VIBRRA</div>
          <div class="node-desc">Clientes ¬∑ Anfitriones<br>Mobile + Web</div>
        </div>
        <div class="node ext" id="n-ext" onclick="showDetail('ext')">
          <span class="node-badge">Chrome</span>
          <span class="node-icon">üñ•Ô∏è</span>
          <div class="node-name">Extensi√≥n Chrome</div>
          <div class="node-desc">Control del jukebox<br>PC del anfitri√≥n</div>
        </div>
        <div class="node client" id="n-superadmin" onclick="showDetail('superadmin')">
          <span class="node-badge">Flutter Web</span>
          <span class="node-icon">‚öôÔ∏è</span>
          <div class="node-name">Panel Superadmin</div>
          <div class="node-desc">VIBRRA internamente<br>Gesti√≥n global</div>
        </div>
        <div class="node client" id="n-empresarios" onclick="showDetail('empresarios')">
          <span class="node-badge">Flutter</span>
          <span class="node-icon">üì£</span>
          <div class="node-name">M√≥dulo Empresarios</div>
          <div class="node-desc">Campa√±as ¬∑ CRM<br>En construcci√≥n</div>
        </div>
      </div>
    </div>

    <!-- CAPA 2: FIREBASE CORE -->
    <div class="layer">
      <div class="layer-label">Capa 2 ‚Äî Firebase Backend</div>
      <div class="nodes-row">
        <div class="node firebase" id="n-auth" onclick="showDetail('auth')">
          <span class="node-badge">Auth</span>
          <span class="node-icon">üîë</span>
          <div class="node-name">Firebase Auth</div>
          <div class="node-desc">Email/pass ¬∑ Custom Token<br>para extensi√≥n</div>
        </div>
        <div class="node firebase" id="n-firestore" onclick="showDetail('firestore')">
          <span class="node-badge">Firestore</span>
          <span class="node-icon">üóÑÔ∏è</span>
          <div class="node-name">Firestore</div>
          <div class="node-desc">Econom√≠a permanente<br>28 colecciones</div>
        </div>
        <div class="node rtdb" id="n-rtdb" onclick="showDetail('rtdb')">
          <span class="node-badge">RTDB</span>
          <span class="node-icon">‚ö°</span>
          <div class="node-name">Realtime DB</div>
          <div class="node-desc">Cola ¬∑ Sesi√≥n viva<br>Vol√°til ‚Äî ~100ms</div>
        </div>
        <div class="node fn" id="n-functions" onclick="showDetail('functions')">
          <span class="node-badge">Functions</span>
          <span class="node-icon">‚öôÔ∏è</span>
          <div class="node-name">Cloud Functions</div>
          <div class="node-desc">12 funciones<br>Triggers + Jobs</div>
        </div>
        <div class="node storage" id="n-storage" onclick="showDetail('storage')">
          <span class="node-badge">Storage</span>
          <span class="node-icon">üóÇÔ∏è</span>
          <div class="node-name">Firebase Storage</div>
          <div class="node-desc">QR PNG ¬∑ Fotos<br>Campa√±as</div>
        </div>
      </div>
    </div>

    <!-- CAPA 3: SERVICIOS EXTERNOS -->
    <div class="layer">
      <div class="layer-label">Capa 3 ‚Äî Servicios externos</div>
      <div class="nodes-row">
        <div class="node external" id="n-youtube" onclick="showDetail('youtube')">
          <span class="node-badge">API</span>
          <span class="node-icon">‚ñ∂Ô∏è</span>
          <div class="node-name">YouTube</div>
          <div class="node-desc">Reproducci√≥n ¬∑ B√∫squeda<br>IFrame API</div>
        </div>
        <div class="node external" id="n-wompi" onclick="showDetail('wompi')">
          <span class="node-badge">Wompi</span>
          <span class="node-icon">üí≥</span>
          <div class="node-name">Wompi / Bancolombia</div>
          <div class="node-desc">Nequi ¬∑ PSE ¬∑ Tarjeta<br>2.49% + $900</div>
        </div>
        <div class="node external" id="n-osa" onclick="showDetail('osa')">
          <span class="node-badge">OSA</span>
          <span class="node-icon">üéº</span>
          <div class="node-name">SAYCO / ACINPRO</div>
          <div class="node-desc">Derechos de autor<br>Ley 23/1982</div>
        </div>
        <div class="node external" id="n-dian" onclick="showDetail('dian')">
          <span class="node-badge">DIAN</span>
          <span class="node-icon">üßæ</span>
          <div class="node-name">DIAN / Facturaci√≥n</div>
          <div class="node-desc">Factura electr√≥nica<br>IVA ¬∑ Retenci√≥n</div>
        </div>
        <div class="node external" id="n-gmaps" onclick="showDetail('gmaps')">
          <span class="node-badge">Google</span>
          <span class="node-icon">üó∫Ô∏è</span>
          <div class="node-name">Google Maps</div>
          <div class="node-desc">Mapa de establecimientos<br>Flutter plugin</div>
        </div>
      </div>
    </div>

    <!-- RESUMEN DE STATS -->
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;margin-top:8px;">
      <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:6px;">Latencia tiempo real</div>
        <div style="font-family:'Playfair Display',serif;font-size:28px;color:var(--rtdb);">~100ms</div>
        <div style="font-size:11px;color:var(--muted);margin-top:3px;">RTDB ‚Üí todos los clientes</div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:6px;">Progreso canci√≥n</div>
        <div style="font-family:'Playfair Display',serif;font-size:28px;color:var(--gold);">0 ops</div>
        <div style="font-size:11px;color:var(--muted);margin-top:3px;">Calculado localmente cada 500ms</div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:6px;">Colecciones Firestore</div>
        <div style="font-family:'Playfair Display',serif;font-size:28px;color:var(--firebase);">28</div>
        <div style="font-size:11px;color:var(--muted);margin-top:3px;">Core + Stats + CRM</div>
      </div>
      <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:6px;">Costo a escala (200 est)</div>
        <div style="font-family:'Playfair Display',serif;font-size:28px;color:var(--fn);">~$2.35</div>
        <div style="font-size:11px;color:var(--muted);margin-top:3px;">USD/mes total Firebase</div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê FLUJO DE PUJA ‚ïê‚ïê -->
  <div id="sec-puja" class="scenario-section">
    <div class="flow-banner">
      <strong>Flujo de puja</strong> ‚Äî Un cliente quiere que su canci√≥n suene primero.<br>
      La puja pasa por RTDB (para velocidad y atomicidad), y el dinero se escribe en Firestore de forma <strong>inmediata e independiente</strong>.
    </div>
    <div style="display:flex;flex-direction:column;gap:0;">

      <div style="display:grid;grid-template-columns:1fr 40px 1fr 40px 1fr 40px 1fr 40px 1fr;gap:0;align-items:center;">

        <div class="node client" style="cursor:default">
          <span class="node-icon">üì±</span>
          <div class="node-name">App Cliente</div>
          <div class="node-desc">Toca "Pujar"<br>Ingresa monto</div>
        </div>
        <div style="text-align:center;color:var(--muted);font-size:20px;">‚Üí</div>
        <div class="node rtdb" style="cursor:default">
          <span class="node-icon">‚ö°</span>
          <div class="node-name">RTDB Transaction</div>
          <div class="node-desc">runTransaction()<br>At√≥mico ‚Äî ~80ms</div>
        </div>
        <div style="text-align:center;color:var(--muted);font-size:20px;">‚Üí</div>
        <div class="node firebase" style="cursor:default">
          <span class="node-icon">üóÑÔ∏è</span>
          <div class="node-name">Firestore batch</div>
          <div class="node-desc">Pujas/{id}<br>Movimientos/{id}<br>increment saldo</div>
        </div>
        <div style="text-align:center;color:var(--muted);font-size:20px;">‚Üí</div>
        <div class="node ext" style="cursor:default">
          <span class="node-icon">üñ•Ô∏è</span>
          <div class="node-name">Extensi√≥n Chrome</div>
          <div class="node-desc">onSnapshot RTDB<br>Reordena cola</div>
        </div>
        <div style="text-align:center;color:var(--muted);font-size:20px;">‚Üí</div>
        <div class="node client" style="cursor:default">
          <span class="node-icon">üì±</span>
          <div class="node-name">Todos los clientes</div>
          <div class="node-desc">onSnapshot RTDB<br>UI actualizada</div>
        </div>

      </div>

      <div style="margin-top:32px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:16px;">L√≠nea de tiempo</div>
        <div class="detail-flow">
          <div><span class="step">T+0ms</span>   Cliente toca "Pujar $3.000"</div>
          <div><span class="step">T+20ms</span>  <span class="arrow">‚Üí</span> runTransaction() en RTDB cola/{itemId}</div>
          <div><span class="step">T+80ms</span>  <span class="arrow">‚Üí</span> Si gan√≥: saldo cliente decrementado localmente</div>
          <div><span class="step">T+80ms</span>  <span class="arrow">‚Üí</span> Firestore batch: Pujas/{id} + Movimientos/{id} + increment retiro_pendiente</div>
          <div><span class="step">T+100ms</span> <span class="arrow">‚Üí</span> RTDB notifica a Extensi√≥n Chrome (WebSocket)</div>
          <div><span class="step">T+120ms</span> <span class="arrow">‚Üí</span> Extensi√≥n reordena cola en memoria</div>
          <div><span class="step">T+130ms</span> <span class="arrow">‚Üí</span> RTDB actualizado ‚Üí todos los clientes ven el nuevo orden</div>
          <div><span class="step">T+130ms</span> <span class="arrow">‚Üí</span> Si posici√≥n == 0: push "¬°Tu canci√≥n es la siguiente!"</div>
        </div>
        <div style="margin-top:16px;padding:12px;background:rgba(0,217,163,.06);border-radius:8px;border:1px solid rgba(0,217,163,.2);font-size:12px;color:#00D9A3;font-family:'JetBrains Mono',monospace;">
          <span class="pulse"></span> El dinero est√° en Firestore desde T+80ms. Si el anfitri√≥n apaga el PC en T+81ms, el dinero ya existe.
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê INICIO DE SESI√ìN (Extensi√≥n) ‚ïê‚ïê -->
  <div id="sec-sesion" class="scenario-section">
    <div class="flow-banner">
      <strong>Login QR de la extensi√≥n Chrome</strong> ‚Äî Similar a WhatsApp Web. El anfitri√≥n usa la app para autenticar la extensi√≥n en el PC del bar, sin escribir credenciales.
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:24px;">
      <div class="node client" style="cursor:default">
        <span class="node-icon">üñ•Ô∏è</span>
        <div class="node-name">Extensi√≥n Chrome</div>
        <div class="node-desc">Genera QR temporal<br>V√°lido 2 minutos</div>
      </div>
      <div class="node firebase" style="cursor:default">
        <span class="node-icon">‚öôÔ∏è</span>
        <div class="node-name">Function generateExtensionToken</div>
        <div class="node-desc">Crea customToken<br>Escribe en RTDB sesiones_qr/{token}</div>
      </div>
      <div class="node client" style="cursor:default">
        <span class="node-icon">üì±</span>
        <div class="node-name">App Flutter (m√≥vil)</div>
        <div class="node-desc">Escanea QR<br>Llama Function</div>
      </div>
    </div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:16px;">Secuencia completa</div>
      <div class="detail-flow">
        <div><span class="step">1.</span> Anfitri√≥n abre extensi√≥n ‚Üí genera token aleatorio ‚Üí muestra QR</div>
        <div><span class="step">2.</span> Extensi√≥n escucha RTDB: <span style="color:#B0C4FF">sesiones_qr/{token}</span></div>
        <div><span class="step">3.</span> Anfitri√≥n escanea QR con la app Flutter en su celular</div>
        <div><span class="step">4.</span> App llama <span style="color:#A78BFA">generateExtensionToken(uid, establecimientos)</span></div>
        <div><span class="step">5.</span> Function crea customToken con Firebase Admin SDK</div>
        <div><span class="step">6.</span> Function escribe en RTDB: <span style="color:#B0C4FF">{ customToken, uid, establecimientos, expira: now+120s, usado: false }</span></div>
        <div><span class="step">7.</span> Extensi√≥n detecta el cambio ‚Üí <span style="color:#FFE566">signInWithCustomToken(token)</span></div>
        <div><span class="step">8.</span> Extensi√≥n guarda en <span style="color:#FF6B6B">chrome.storage.local</span>: refreshToken + establecimientos</div>
        <div><span class="step">9.</span> Si tiene m√∫ltiples establecimientos ‚Üí selector ‚Üí lista para operar</div>
      </div>
      <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="padding:12px;background:rgba(255,107,107,.06);border-radius:8px;border:1px solid rgba(255,107,107,.15);font-size:11px;color:#FF6B6B;font-family:'JetBrains Mono',monospace;">
          El token QR expira en 2 minutos y se invalida tras el primer uso. No hay contrase√±as viajando por la red.
        </div>
        <div style="padding:12px;background:rgba(255,229,102,.06);border-radius:8px;border:1px solid rgba(255,229,102,.15);font-size:11px;color:var(--gold);font-family:'JetBrains Mono',monospace;">
          El refreshToken en chrome.storage.local mantiene la sesi√≥n activa 30 d√≠as sin volver a escanear.
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê RECARGA WOMPI ‚ïê‚ïê -->
  <div id="sec-recarga" class="scenario-section">
    <div class="flow-banner">
      <strong>Flujo de recarga de saldo</strong> ‚Äî El cliente recarga desde la app con Nequi, PSE o tarjeta. Wompi procesa el pago y notifica a Firebase v√≠a webhook.
    </div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;align-items:center;margin-bottom:24px;">
      <div class="node client" style="cursor:default">
        <span class="node-icon">üì±</span>
        <div class="node-name">App Cliente</div>
        <div class="node-desc">Selecciona monto<br>Elige m√©todo</div>
      </div>
      <div style="text-align:center;color:var(--muted);font-size:20px;">‚Üí</div>
      <div class="node external" style="cursor:default">
        <span class="node-icon">üí≥</span>
        <div class="node-name">Wompi API</div>
        <div class="node-desc">Checkout URL<br>Nequi deeplink</div>
      </div>
      <div style="text-align:center;color:var(--muted);font-size:20px;">‚Üí</div>
      <div class="node fn" style="cursor:default">
        <span class="node-icon">‚öôÔ∏è</span>
        <div class="node-name">wompiWebhook</div>
        <div class="node-desc">Valida HMAC<br>Acredita saldo</div>
      </div>
    </div>

    <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;">
      <div style="font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--muted);font-family:'JetBrains Mono',monospace;margin-bottom:16px;">Secuencia + c√°lculo econ√≥mico</div>
      <div class="detail-flow">
        <div><span class="step">1.</span> Cliente selecciona recargar $20.000 COP</div>
        <div><span class="step">2.</span> App crea transacci√≥n v√≠a Wompi API ‚Üí recibe checkout URL</div>
        <div><span class="step">3.</span> Cliente completa pago en Nequi / PSE / tarjeta</div>
        <div><span class="step">4.</span> Wompi env√≠a POST webhook a Firebase Function <span style="color:#A78BFA">wompiWebhook</span></div>
        <div><span class="step">5.</span> Function valida firma HMAC (seguridad)</div>
        <div><span class="step">6.</span> Si estado == APPROVED:</div>
        <div style="padding-left:20px;"><span class="step">‚Üí</span> Descuenta comisi√≥n Wompi: $20.000 - ($20.000 √ó 2.49% + $900) = <span style="color:#00D9A3">$18.602 acreditados</span></div>
        <div style="padding-left:20px;"><span class="step">‚Üí</span> Si hay bono activo (ej: 15% primer mes): $18.602 √ó 1.15 = <span style="color:var(--gold)">$21.392 saldo</span></div>
        <div><span class="step">7.</span> Escribe Firestore: Transacciones/{id} + Clientes/{uid}.saldo += monto</div>
        <div><span class="step">8.</span> App recibe actualizaci√≥n v√≠a onSnapshot ‚Üí UI actualizada en tiempo real</div>
      </div>
      <div style="margin-top:16px;padding:12px;background:rgba(96,192,240,.06);border-radius:8px;border:1px solid rgba(96,192,240,.2);font-size:11px;color:#60C0F0;font-family:'JetBrains Mono',monospace;">
        Wompi cubre: Nequi, PSE, Bot√≥n Bancolombia, Visa, Mastercard. Una sola integraci√≥n. Sandbox disponible para pruebas sin dinero real.
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê CIERRE DE SESI√ìN ‚ïê‚ïê -->
  <div id="sec-cierre" class="scenario-section">
    <div class="flow-banner">
      <strong>Cierre de sesi√≥n</strong> ‚Äî Dos escenarios: el anfitri√≥n cierra manualmente, o nunca cierra y el detector de inactividad act√∫a tras 3h sin cambio de canci√≥n.
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">

      <div style="background:var(--card);border:1px solid rgba(0,217,163,.3);border-radius:12px;padding:20px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--rtdb);margin-bottom:14px;letter-spacing:1px;">‚úì CIERRE MANUAL</div>
        <div class="detail-flow" style="font-size:11px;">
          <div><span class="step">1.</span> Anfitri√≥n presiona "Finalizar sesi√≥n" en extensi√≥n</div>
          <div><span class="step">2.</span> Extensi√≥n llama <span style="color:#A78BFA">cerrarSesion(estId)</span></div>
          <div><span class="step">3.</span> Function lee datos acumulados en RTDB</div>
          <div><span class="step">4.</span> Batch Firestore:</div>
          <div style="padding-left:16px;"><span style="color:#B0C4FF">Sesiones/{id}</span> ‚Äî resumen de la noche</div>
          <div style="padding-left:16px;"><span style="color:#B0C4FF">Stats_Establecimientos/{id}</span></div>
          <div style="padding-left:16px;"><span style="color:#B0C4FF">Stats_Canciones/{vid}</span></div>
          <div style="padding-left:16px;"><span style="color:#B0C4FF">Stats_Horarios/{id}</span></div>
          <div><span class="step">5.</span> <span style="color:#FF6B6B">remove(sesiones/{estId})</span> ‚Äî RTDB limpio</div>
          <div><span class="step">6.</span> sesion_activa = false en Firestore</div>
          <div><span class="step">7.</span> Clientes ven "Sesi√≥n finalizada"</div>
        </div>
      </div>

      <div style="background:var(--card);border:1px solid rgba(255,229,102,.2);border-radius:12px;padding:20px;">
        <div style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--gold);margin-bottom:14px;letter-spacing:1px;">‚ö† INACTIVIDAD (PC apagado)</div>
        <div class="detail-flow" style="font-size:11px;">
          <div><span class="step">1.</span> Anfitri√≥n apaga el PC ‚Äî sin cerrar sesi√≥n</div>
          <div><span class="step">2.</span> El dinero ya est√° en Firestore (por puja)</div>
          <div><span class="step">3.</span> <span style="color:#A78BFA">detectarSesionesInactivas</span> corre cada hora</div>
          <div><span class="step">4.</span> Verifica <span style="color:#B0C4FF">ultima_actividad</span> de cada sesi√≥n</div>
          <div><span class="step">5.</span> Si sin cambio de canci√≥n por > 3h:</div>
          <div style="padding-left:16px;"><span style="color:#B0C4FF">‚Üí</span> toma stats del RTDB</div>
          <div style="padding-left:16px;"><span style="color:#B0C4FF">‚Üí</span> escribe Sesiones/{id} + Stats_*</div>
          <div style="padding-left:16px;"><span style="color:#B0C4FF">‚Üí</span> cierre_tipo = "inactividad"</div>
          <div style="padding-left:16px;"><span style="color:#FF6B6B">‚Üí</span> remove(sesiones/{estId})</div>
          <div><span class="step">6.</span> sesion_activa = false autom√°ticamente</div>
        </div>
        <div style="margin-top:12px;padding:10px;background:rgba(255,229,102,.05);border-radius:6px;border:1px solid rgba(255,229,102,.1);font-size:10px;color:var(--gold);font-family:'JetBrains Mono',monospace;">
          ultima_actividad se actualiza con cada cambio de canci√≥n ‚Äî ~1 write RTDB cada 5-6 min. No hay heartbeat cada 30s.
        </div>
      </div>

    </div>
  </div>

</div><!-- /canvas -->

<!-- ‚îÄ‚îÄ OVERLAY ‚îÄ‚îÄ -->
<div class="overlay" id="overlay" onclick="closeDetail()"></div>

<!-- ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ -->
<div class="detail-panel" id="detailPanel">
  <button class="detail-close" onclick="closeDetail()">‚úï</button>
  <div id="detailContent"></div>
</div>

<script>
// ‚îÄ‚îÄ DATOS DE DETALLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const details = {
  app: {
    icon: 'üì±', name: 'App VIBRRA', type: 'Flutter ¬∑ iOS ¬∑ Android ¬∑ Web',
    desc: 'Aplicaci√≥n principal de VIBRRA. Corre en dispositivos m√≥viles y en navegador. Sirve a todos los tipos de usuario con guards de navegaci√≥n seg√∫n el rol.',
    sections: [
      { title: 'Tecnolog√≠a', items: [
        ['Framework', 'Flutter (Dart)'],
        ['Estado', 'Bloc + Clean Architecture'],
        ['Auth', 'Firebase Auth (email/pass)'],
        ['DB', 'Firestore + Realtime DB'],
        ['Mapas', 'Google Maps Flutter plugin'],
        ['Pagos', 'Wompi SDK + WebView'],
      ]},
      { title: 'M√≥dulos', items: [
        ['Cliente', 'Sesi√≥n QR, cola, pujas, saldo'],
        ['Anfitri√≥n', 'Login QR extensi√≥n, stats, retiros'],
        ['Superadmin', 'Gesti√≥n global, campa√±as'],
        ['Empresarios', 'Campa√±as publicitarias (WIP)'],
      ]},
    ],
    connects: ['Firebase Auth', 'Firestore', 'Realtime DB', 'Wompi', 'Google Maps'],
  },
  ext: {
    icon: 'üñ•Ô∏è', name: 'Extensi√≥n Chrome', type: 'Chrome Extension ¬∑ JavaScript',
    desc: 'El coraz√≥n del jukebox. Corre en el PC del bar, controla YouTube y escucha el RTDB para saber qu√© reproducir. Comunica ambos mundos: las pujas de los clientes con el reproductor f√≠sico.',
    sections: [
      { title: 'Tecnolog√≠a', items: [
        ['Plataforma', 'Chrome Extension Manifest V3'],
        ['Auth', 'Firebase Custom Token (QR)'],
        ['Storage', 'chrome.storage.local'],
        ['YouTube', 'IFrame Player API'],
        ['RTDB', 'Firebase Realtime SDK (WebSocket)'],
      ]},
      { title: 'Responsabilidades', items: [
        ['Reproducci√≥n', 'Controla YouTube IFrame API'],
        ['Cola', 'Escucha RTDB cola en tiempo real'],
        ['QR flotante', 'div fixed sobre YouTube ‚Äî legal'],
        ['Heartbeat', '1 write RTDB por cambio de canci√≥n'],
        ['Cierre', 'Llama cerrarSesion() o detecta inactividad'],
      ]},
    ],
    connects: ['Realtime DB', 'Firebase Auth', 'YouTube', 'Cloud Functions'],
  },
  firestore: {
    icon: 'üóÑÔ∏è', name: 'Cloud Firestore', type: 'Firebase ¬∑ NoSQL ¬∑ Persistente',
    desc: 'Base de datos principal para todo lo permanente. Datos econ√≥micos, perfiles, estad√≠sticas, documentaci√≥n legal. Todo lo que no puede perderse vive aqu√≠.',
    sections: [
      { title: 'Colecciones core (econom√≠a)', items: [
        ['Anfitriones/{uid}', 'Perfil + docs legales + suscripci√≥n'],
        ['Establecimientos/{id}', '34 campos ‚Äî identidad, precios, econom√≠a, docs'],
        ['Pujas/{id}', 'Cada puja ganada ‚Äî escritura inmediata'],
        ['Sesiones/{id}', 'Resumen al cerrar sesi√≥n'],
        ['Transacciones/{id}', 'Recargas Wompi'],
        ['Bonos/{id}', 'Trazabilidad DIAN ‚Äî Art. 107 E.T.'],
      ]},
      { title: 'Colecciones stats + CRM', items: [
        ['Stats_Canciones/{vid}', 'Ranking global de canciones'],
        ['Stats_Establecimientos/{id}', 'Rendimiento del local'],
        ['Stats_Plataforma/global', 'M√©tricas de toda la plataforma'],
        ['Perfiles/{uid}', 'Comportamiento inferido (CRM)'],
        ['Segmentos/{nombre}', 'Calculados nightly ‚Äî 10 segmentos'],
        ['Campanas/{id}', 'Campa√±as publicitarias de empresarios'],
      ]},
    ],
    connects: ['App VIBRRA', 'Cloud Functions', 'Panel Superadmin'],
  },
  rtdb: {
    icon: '‚ö°', name: 'Firebase Realtime DB', type: 'RTDB ¬∑ WebSocket ¬∑ Vol√°til',
    desc: 'El bus de tiempo real de VIBRRA. Latencia ~100ms. Todo lo que vive aqu√≠ durante la sesi√≥n se destruye al cerrarla. Nunca se almacena dinero aqu√≠.',
    sections: [
      { title: 'Estructura en sesi√≥n', items: [
        ['sesiones/{estId}/estado/', 'activa, cancion_actual, ultima_actividad'],
        ['sesiones/{estId}/cola/', 'Items ordenados por puja_mayor'],
        ['sesiones/{estId}/presencia/', 'Usuarios conectados (onDisconnect)'],
        ['sesiones/{estId}/reacciones/', 'Emojis a canciones ‚Äî ef√≠meros'],
        ['sesiones/{estId}/leaderboard/', 'DJ noche, canci√≥n m√°s pujada'],
        ['sesiones/{estId}/batalla/', 'Votaci√≥n entre 2 canciones'],
        ['sesiones_qr/{token}/', 'Auth extensi√≥n ‚Äî expira 2 min'],
      ]},
      { title: 'Reglas clave', items: [
        ['runTransaction()', 'Pujas at√≥micas ‚Äî nadie se roba la posici√≥n'],
        ['onDisconnect()', 'Limpieza autom√°tica de presencia al desconectar'],
        ['ultima_actividad', '1 write por cambio de canci√≥n (~40/noche)'],
        ['remove()', 'Todo el nodo se destruye al cerrar sesi√≥n'],
      ]},
    ],
    connects: ['App VIBRRA', 'Extensi√≥n Chrome', 'Cloud Functions'],
  },
  functions: {
    icon: '‚öôÔ∏è', name: 'Cloud Functions', type: 'Node.js ¬∑ Firebase Functions v2',
    desc: '12 funciones que orquestan toda la l√≥gica de negocio: triggers de Firestore, jobs programados, webhooks externos y la l√≥gica de sesi√≥n.',
    sections: [
      { title: 'Functions de sesi√≥n', items: [
        ['generateExtensionToken', 'onCall ‚Äî QR login extensi√≥n'],
        ['cerrarSesion', 'onCall ‚Äî batch stats a Firestore'],
        ['detectarSesionesInactivas', 'onSchedule cada hora ‚Äî 3h sin canci√≥n'],
      ]},
      { title: 'Functions econ√≥micas', items: [
        ['wompiWebhook', 'onRequest ‚Äî valida HMAC, acredita saldo'],
        ['verificarDocumentosVencimiento', 'onSchedule 9am ‚Äî alerta OSA/docs'],
        ['facturarCampanas', 'onSchedule 1am ‚Äî descuenta presupuesto'],
      ]},
      { title: 'Functions de datos', items: [
        ['resetBeneficiosMensuales', 'onSchedule d√≠a 1 ‚Äî 3 canciones + 2 conexiones'],
        ['actualizarPerfil', 'onDocumentCreated Eventos/stream'],
        ['recalcularSegmentos', 'onSchedule 3am ‚Äî 10 segmentos CRM'],
        ['deteccionChurn', 'onSchedule 10am ‚Äî 14 y 30 d√≠as inactivo'],
        ['procesarEncuestas', 'onSchedule medianoche'],
        ['limpiarEventosAntiguos', 'onSchedule d√≠a 1 ‚Äî 90 d√≠as TTL'],
      ]},
    ],
    connects: ['Firestore', 'Realtime DB', 'Wompi', 'App VIBRRA'],
  },
  auth: {
    icon: 'üîë', name: 'Firebase Auth', type: 'Firebase Authentication',
    desc: 'Gestiona la identidad de todos los usuarios. Los clientes se autentican con email/contrase√±a. La extensi√≥n Chrome usa Custom Tokens generados por Functions.',
    sections: [
      { title: 'M√©todos de autenticaci√≥n', items: [
        ['Email/Password', 'Clientes, Anfitriones, Superadmin'],
        ['Custom Token', 'Extensi√≥n Chrome ‚Äî generado v√≠a QR'],
        ['Anonymous', 'An√≥nimos ‚Äî device_id tracking en Firestore'],
      ]},
      { title: 'Seguridad', items: [
        ['Firestore Rules', 'Cada colecci√≥n valida rol del usuario'],
        ['RTDB Rules', 'Solo puede escribir en su propio nodo'],
        ['Custom Claims', 'rol: superadmin para guards en app'],
      ]},
    ],
    connects: ['App VIBRRA', 'Extensi√≥n Chrome', 'Cloud Functions', 'Firestore'],
  },
  storage: {
    icon: 'üóÇÔ∏è', name: 'Firebase Storage', type: 'Cloud Storage ¬∑ Firebase',
    desc: 'Almacenamiento de archivos binarios: im√°genes QR de establecimientos, fotos de portada, creatividades de campa√±as publicitarias.',
    sections: [
      { title: 'Contenido almacenado', items: [
        ['QR PNG', 'vibrra.live/neg/{id} ‚Äî para imprimir en el bar'],
        ['foto_portada_url', 'Imagen del establecimiento en el mapa'],
        ['Campa√±as', 'Banners y videos de empresarios'],
        ['Logo anfitri√≥n', 'Visible en el QR flotante de YouTube'],
      ]},
    ],
    connects: ['App VIBRRA', 'Extensi√≥n Chrome', 'Firestore'],
  },
  youtube: {
    icon: '‚ñ∂Ô∏è', name: 'YouTube IFrame API', type: 'Google ¬∑ JavaScript API',
    desc: 'La fuente de m√∫sica de VIBRRA. La extensi√≥n Chrome inyecta el IFrame Player sobre youtube.com y lo controla program√°ticamente. El QR flotante es un div con position:fixed ‚Äî legal, solo modifica el DOM local.',
    sections: [
      { title: 'Uso en VIBRRA', items: [
        ['B√∫squeda', 'YouTube Data API v3 ‚Äî buscar canciones'],
        ['Reproducci√≥n', 'IFrame Player API ‚Äî loadVideoById()'],
        ['QR flotante', 'div inyectado sobre youtube.com'],
        ['Evento ENDED', 'Dispara el cambio de canci√≥n autom√°tico'],
        ['duracion_ms', 'Se obtiene de la API al cargar el video'],
      ]},
      { title: 'Consideraciones legales', items: [
        ['IFrame API', 'Uso comercial requiere licencia YouTube Premium'],
        ['OSA', 'SAYCO/ACINPRO cubre la m√∫sica en el establecimiento'],
        ['Contrato', 'Anfitri√≥n declara ser responsable de las licencias'],
      ]},
    ],
    connects: ['Extensi√≥n Chrome'],
  },
  wompi: {
    icon: 'üí≥', name: 'Wompi / Bancolombia', type: 'Pasarela de pagos ¬∑ Colombia',
    desc: 'Pasarela de pagos de Bancolombia. Una sola integraci√≥n cubre Nequi, PSE, Bot√≥n Bancolombia y tarjetas. Genera confianza por el respaldo de Bancolombia.',
    sections: [
      { title: 'M√©todos disponibles', items: [
        ['Nequi', 'Deeplink directo ‚Äî m√°s popular en Colombia'],
        ['PSE', 'D√©bito bancario ‚Äî todos los bancos'],
        ['Bot√≥n Bancolombia', 'D√©bito Bancolombia'],
        ['Tarjeta', 'Visa, Mastercard, cr√©dito/d√©bito'],
      ]},
      { title: 'Costos', items: [
        ['Comisi√≥n', '2.49% + $900 COP por transacci√≥n'],
        ['Qui√©n paga', 'Se descuenta del saldo a acreditar'],
        ['Sandbox', 'Disponible para pruebas sin dinero real'],
        ['Webhook', 'HTTPS POST a Cloud Function con firma HMAC'],
      ]},
    ],
    connects: ['App VIBRRA', 'Cloud Functions (wompiWebhook)', 'Firestore'],
  },
  osa: {
    icon: 'üéº', name: 'OSA ‚Äî SAYCO/ACINPRO', type: 'Derechos de autor ¬∑ Colombia',
    desc: 'Organizaci√≥n Sayco Acinpro ‚Äî √∫nica entidad legal para licenciar el 99% de la m√∫sica en Colombia. El certificado OSA es el √∫nico documento que VIBRRA verifica activamente: sin √©l, no se puede abrir sesi√≥n.',
    sections: [
      { title: 'Relaci√≥n con VIBRRA', items: [
        ['Responsable', 'El anfitri√≥n ‚Äî no VIBRRA'],
        ['Bloqueo', 'doc_sayco_acinpro_vigente == false ‚Üí sin sesi√≥n'],
        ['Alerta', '30, 15 y 5 d√≠as antes del vencimiento (push)'],
        ['Base legal', 'Ley 23/1982 Art. 158-159'],
        ['Renovaci√≥n', 'Anual ‚Äî pago a OSA seg√∫n tarifa del establecimiento'],
      ]},
    ],
    connects: ['Establecimientos/{id}', 'Cloud Functions (verificarDocumentosVencimiento)'],
  },
  dian: {
    icon: 'üßæ', name: 'DIAN / Facturaci√≥n', type: 'Obligaciones tributarias ¬∑ Colombia',
    desc: 'VIBRRA opera como intermediario y agente retenedor. Emite factura electr√≥nica por cada comisi√≥n cobrada al anfitri√≥n y retiene en la fuente seg√∫n el tipo de persona.',
    sections: [
      { title: 'Obligaciones de VIBRRA', items: [
        ['IVA 19%', 'Sobre el 30% de comisi√≥n (intermediaci√≥n)'],
        ['Retenci√≥n fuente', '3.5% - 6% seg√∫n tipo de anfitri√≥n'],
        ['ICA', 'En municipio de registro de VIBRRA'],
        ['Factura electr√≥nica', 'Por cada comisi√≥n cobrada'],
        ['Suscripci√≥n $15K', 'Excluida de IVA ‚Äî SaaS (DIAN 190/2024)'],
      ]},
    ],
    connects: ['Anfitriones/Movimientos', 'Transacciones', 'Cloud Functions'],
  },
  gmaps: {
    icon: 'üó∫Ô∏è', name: 'Google Maps', type: 'Google Maps Platform ¬∑ Flutter',
    desc: 'Permite que los clientes descubran establecimientos VIBRRA activos en su ciudad antes de salir. Visualizaci√≥n de bares con sesi√≥n activa, precio de conexi√≥n y g√©neros musicales.',
    sections: [
      { title: 'Uso en VIBRRA', items: [
        ['Plugin', 'google_maps_flutter'],
        ['Datos', 'Firestore: lat, lng, sesion_activa, visible_en_mapa'],
        ['Filtros', 'Ciudad, barrio, g√©nero, precio, activo ahora'],
        ['Perfil', 'Tap en marcador ‚Üí Establecimientos/{id}/Perfil_Publico'],
      ]},
    ],
    connects: ['App VIBRRA', 'Firestore (Establecimientos)'],
  },
  superadmin: {
    icon: '‚öôÔ∏è', name: 'Panel Superadmin', type: 'Flutter Web ¬∑ Interno VIBRRA',
    desc: 'Panel interno de VIBRRA para gestionar toda la plataforma. Acceso restringido por guard de rol superadmin en Firestore.',
    sections: [
      { title: 'Funcionalidades', items: [
        ['Establecimientos', 'Activar/desactivar, ver estado docs'],
        ['Retiros', 'Aprobar retiros pendientes de anfitriones'],
        ['M√©tricas', 'Stats globales, ingresos, retenci√≥n'],
        ['Campa√±as', 'Aprobar/rechazar campa√±as de empresarios'],
        ['Impuestos', 'Configurar tarifas ICA por municipio'],
        ['Usuarios', 'Gesti√≥n de cuentas y roles'],
      ]},
    ],
    connects: ['Firestore', 'Cloud Functions'],
  },
  empresarios: {
    icon: 'üì£', name: 'M√≥dulo Empresarios', type: 'Flutter ¬∑ En construcci√≥n',
    desc: 'M√≥dulo para empresas que quieren poner publicidad en los bares VIBRRA. Compran contra segmentos de CRM sin ver datos individuales.',
    sections: [
      { title: 'Funcionalidades planeadas', items: [
        ['Registro', 'Raz√≥n social, NIT, saldo'],
        ['Campa√±as', 'Banner, video corto, canci√≥n patrocinada'],
        ['Segmentos', 'Comprar contra: reggaetoneros, vip, etc.'],
        ['M√©tricas', 'Impresiones, clicks, CTR'],
        ['Facturaci√≥n', 'Descuento diario autom√°tico del presupuesto'],
      ]},
    ],
    connects: ['Firestore (Campanas)', 'Cloud Functions', 'Firebase Storage'],
  },
};

function showDetail(id) {
  const d = details[id];
  if (!d) return;

  let html = `
    <div class="detail-icon">${d.icon}</div>
    <div class="detail-name">${d.name}</div>
    <div class="detail-type">${d.type}</div>
    <div class="detail-desc">${d.desc}</div>
  `;

  if (d.sections) {
    d.sections.forEach(sec => {
      html += `<div class="detail-section">
        <div class="detail-section-title">${sec.title}</div>`;
      sec.items.forEach(([k, v]) => {
        html += `<div class="detail-item">
          <span class="detail-item-key">${k}</span>
          <span class="detail-item-val">${v}</span>
        </div>`;
      });
      html += `</div>`;
    });
  }

  if (d.connects) {
    html += `<div class="detail-section">
      <div class="detail-section-title">Se conecta con</div>
      <div class="connects-to">
        ${d.connects.map(c => `<span class="connect-chip">${c}</span>`).join('')}
      </div>
    </div>`;
  }

  document.getElementById('detailContent').innerHTML = html;
  document.getElementById('detailPanel').classList.add('open');
  document.getElementById('overlay').classList.add('active');
}

function closeDetail() {
  document.getElementById('detailPanel').classList.remove('open');
  document.getElementById('overlay').classList.remove('active');
}

function showScenario(name) {
  document.querySelectorAll('.scenario-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.scenario-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('sec-' + name).classList.add('active');
  event.target.classList.add('active');
}
</script>
</body>
</html>
